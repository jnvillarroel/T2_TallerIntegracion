<html>
  <head>
    <title>Trivia</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  </head>
  <body class= "main-header">
    <!-- FRONT PAGE -->
    <div id="front_page">
      <div class="container shadow-lg min-vh-100 my-4 py-5 bg-light text-center">
        <br><br><br><br>
        <h1 style="font-size: 60px;" class="my-5">INTEGRATION TRIVIA</h1>
        <form style="display: flex;align-items: center;justify-content: center;" class="mt-5">
          <div class="form-group w-50 p-4 m-3 content">
            <input  type="text" class="form-control text-center" id="name"  placeholder="Ingresa tu nombre de usuario">
          </div>
          <button  type="button" class="btn btn-secondary" onclick="inscripcion_user(document.getElementById('name').value)">Ingresar</button>
        </form>
      </div>
    </div>
    <!-- FRONT PAGE -->
    <!-- LOBBY -->
    <div class="container shadow-lg min-vh-100 my-4 py-5 bg-light text-center" style="align-items: center;" id="lobby">

      <div style="width: 100%; align-items: center;">
        <h1 style="text-align: center; font-size: 60px;">LOBBY</h1>
        <h3 id="timer" style="text-align: center; font-size: 30px;" class="m-3"></h3>

        <div id="players_lobby" style="text-align:center; align-items: center; font-size:35px; background: rgba(219, 216, 216, 0.7); border-radius:10px;  display:flex; flex-wrap:wrap;" class="m-5 p-5 align-content"></div>
      </div>
    </div>
    <!-- LOBBY -->
    <!-- GAME -->
    <div id="game">
      <div class="container shadow-lg min-vh-100 my-4 py-5 bg-light">
        <div class="row">
          <div class="col"><h3 id="trivia_id" class="mb-2 "></h3></div>
          <div class="col" id="streak"></div>
        </div>

        <div class="row">
          <div class="col-8">
            <div class="container-m p-4" style="height: 640; background: rgba(219, 216, 216, 0.7);">
              <div class="row">
                <div class="col"> 
                  <h2 id="question"></h2>
                </div>
                <div class="col" style=" text-align: left;">
                  <h2 id="timer_game">TIME LEFT: 20</h2>
                </div>
              </div>

              <h2 class="p-5 mt-5" style="text-align: center;" id="question_title"></h2>
              <div class="container" id="pool_respuestas">
                <!-- BOTONES -->
                <div id="button">
                  <div class="row m-2">  
                    <div class="col">
                      <button id="b1" type="button" class="btn btn-secondary active btn-lg h-100 w-100" onclick="respuesta_texto(question_id,'1')" >Button</button>
                    </div>
                    <div class="col">
                      <button id="b2"type="button" class="btn btn-secondary active btn-lg h-100 w-100" onclick="respuesta_texto(question_id,'2')">Button</button>
                    </div>  
                  </div>
                  <div class="row m-2">  
                    <div class="col">
                      <button id="b3"type="button" class="btn btn-secondary active btn-lg h-100 w-100" onclick="respuesta_texto(question_id,'3')">Button</button>
                    </div>
                    <div class="col">
                      <button id="b4" type="button" class="btn btn-secondary active btn-lg h-100 w-100" onclick="respuesta_texto(question_id,'4')">Button</button>
                    </div>  
                  </div>
                </div>
                <!-- BOTONES -->
                <!-- TEXTO -->
                <div id="text">
                  <form style="display: flex;align-items: center;justify-content: center;">
                    <div class="form-group w-100 p-4"  id="input_space" style="display: flex;align-items: center;justify-content: center;">
                      <!-- <input type="answer" class="form-control" id="texto" placeholder="Ingresa tu respuesta"> -->
                    </div>
                    <button type="button" class="btn btn-secondary active btn-lg" onclick="respuesta_texto(question_id, texto)">Enviar!</button>
                  </form>
                </div>
                <!-- TEXTO -->
                <!-- CHAT -->
                <div id="chat">

                </div>
                <!-- CHAT -->
              </div>
              <div id="resultado" class="pt-5" style="text-align: center; font-size: x-large;"></div>
            </div>
          </div>
          <div class="col-4">
            <div id="scoreboard" class="container-m p-4 btn-secondary" style="height: 640;"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- GAME -->
    <!-- HIGH SCORES -->
    <div class="container shadow-lg min-vh-100 my-4 py-5 bg-light text-center" style="align-items: center;" id="high_scores">
      <h1 style="text-align: center; font-size: 60px;" id="titulo"></h1>
      <div class="container m-3 p-3" id="podio_titulos" style="background: rgba(219, 216, 216, 0.7);">
        <div class="row m-3">
          <div class="col font-weight-bold" style="text-align: center;" ><h2>Place</h2></div>
          <div class="col font-weight-bold" style="text-align: center;"><h2>Username</h2></div>
          <div class="col font-weight-bold" style="text-align: center;"><h2>Score</h2></div> 
        </div>
      </div>
    </div>
    <!-- HIGH SCORES -->

  </body>


<script>

$("#front_page").show();
$("#lobby").hide();
$("#game").hide();
$("#high_scores").hide();
let socket = new WebSocket("wss://trivia.tallerdeintegracion.cl/connect");

var trivia_id = 0;
var joined = 0;
var question_id = 0;
// Listen for messages
socket.addEventListener('message', function (event) {
  console.log('Message from server ', event.data);
});

socket.onopen = function(e) {
  console.log("CONNECTED")
};

socket.onmessage = function(event) {
  let data = JSON.parse(event.data);
  if (data.type=='accepted') {
    trivia_id= data.trivia_id;
    joined=data.joined;
  }
  if (data.type=='denied') {
    console.log('Message from server ', event.data);
  }
  else if (data.type=='lobby'){
    $("#front_page").hide();
    refresh_lobby(data);
  }
  else if (data.type=='score'){
    $("#lobby").hide();
    $("#front_page").hide();
    refresh_game(data)
  }
  else if (data.type=='timer'){
    refresh_timer(data)
  }
  else if (data.type=='question'){
    refresh_question(data)
  }
  else if (data.type=='result'){
    refresh_result(data)
  }
  else if (data.type=='streak'){
    refresh_streak(data)
  }
  else if (data.type=='highscore'){
    refresh_highscore(data)
  }
  else if (data.type=='disconnected'){
    $("#front_page").show();
    $("#game").hide();
    $("#high_scores").hide();
  }

};

function refresh_highscore(data){
  $("#game").hide();
  $("#high_scores").show();
  $("#titulo").text("GANADORES TRIVIA "+ trivia_id)
  // $("#podio_titulos").html('')
  // $("#podio").append('<div class="row"> <div class="col-3"><p>Place2</p></div> <div class="col-6"><p>Username2</p></div> <div class="col-3"><p>Score2</p></div> </div>')
  $("#podio").html("");
  for (var i =0 ; i < 3; i++) {
    var jugador = '<div class="row mt-5"> <div class="col" style="text-align: center;" ><h4 style="color: rgba(69, 66, 66, 0.7);">#'+(i+1)+'</h4></div> <div class="col" style="text-align: center;" ><h4 style="color: rgba(69, 66, 66, 0.7);">'+data.winners[i].username+'</h4></div> <div class="col" style="text-align: center;" ><h4 style="color: rgba(69, 66, 66, 0.7);">'+data.winners[i].score+'</h4></div> </div><br>';
    $("#podio_titulos").append(jugador);
  }
}

function refresh_streak(data){
  $("#streak").html("<p> "+data.username+" ha alcanzado un streak de "+data.streak+" respuestas correctas!")
}

function respuesta_texto(question_id, texto){
  var msg = JSON.stringify({'type':"answer",'question_id': question_id,'value': texto});
  socket.send(msg)
}

function respuesta_chat(message){
  $("#chat").html("")
}

function inscripcion_user(name) {
  console.log(name)
  if (name == ''){
    name = "Jaime Villarroel"
  }
  var msg = JSON.stringify({'type':'join','id':'6aca7189-ed9f-4836-8021-34ef45fa9800','username': name});
  socket.send(msg);
  }


function refresh_lobby(data) {
  $("#lobby").show();
  $("#question_title").hide()
  $("#pool_respuestas").hide()
  $("#timer").text(data.message);
  $("#players_lobby").html('<p style="text-align:center;  width: 100%;">Current players:</p>');
  for (var i =0 ; i < data.players.length; i++) {
    var next_player = '<b style="font-size:25px; width:33%;">'+data.players[i]+"</b><br>";
    $("#players_lobby").append(next_player);
  }
} 
function refresh_game(data) {
  $("#game").show();
  $("#trivia_id").text("TRIVIA " + trivia_id);
  $("#scoreboard").html('<h4 style="text-align:center;  width: 100%;">SCOREBOARD</h4>');
  $("#scoreboard").append('<div class="row"> <div class="col-3"><p>Place</p></div> <div class="col-6"><p>Username</p></div> <div class="col-3"><p>Score</p></div> </div>')
  var items = Object.keys(data.scores).map(function(key) {
    return [key, data.scores[key]];
  });
  // Sort the array based on the second element
  items.sort(function(first, second) {
    return second[1] - first[1];
  });
  for (var i =0 ; i < Object.keys(data.scores).length; i++) {
    var jugador = '<div class="row"> <div class="col-3">'+(i+1)+'</div> <div class="col-6">'+items[i][0]+'</div> <div class="col-3">'+items[i][1]+'</div> </div>';
    $("#scoreboard").append(jugador);
  }
} 


function refresh_result(data) {
  $("#game").show();
  $("#pool_respuestas").hide()
  $("#resultado").show()
  if (data.correct == true){
    $("#resultado").html("<h1 class='text-success'>Correcto!</h1>")
  }
  else if (data.correct == false){
    $("#resultado").html("<h1 class='text-danger'>Haz fallado!</h1>")
  }
  

} 
function refresh_timer(data){
  // $("#question").text("QUESTION: " + data.question_id);
  $("#timer_game").text("TIME LEFT: " + data.seconds_remaining);
}
function refresh_question(data){
  question_id = data.question_id;
  $("#question").text("QUESTION: " + (data.question_id+1));
  $("#question_title").text(data.question_title);
  $("#question_title").show()
  $("#pool_respuestas").show()
  $("#chat").hide()
    $("#button").hide()
    $("#text").hide()
  $("#resultado").hide()

  if (data.question_type == 'button'){
    $("#button").show()
    
    $("#b1").text(data.question_options["1"])
    $("#b2").text(data.question_options["2"])
    $("#b3").text(data.question_options["3"])
    $("#b4").text(data.question_options["4"])
  }
  else if (data.question_type == 'text'){
    $("#text").show()
    $("#input_space").html('<input type="answer" class="form-control" id="texto" placeholder="Ingresa tu respuesta">')
  }
  else if (data.question_type == 'chat'){
    $("#chat").show()
  }
}
 
</script>

<!-- <div class="col">'+data.scores[i].property+'</div> <div class="col">'+data.scores[i].property+'</div> -->
<!-- <div class="row"> <div class="col">'+i+'</div> </div> -->